name: Tile Updater

on:
  repository_dispatch:
    types: [bundles-ready]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-tiles:
    name: Update Dashboard Tiles
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Update backlog documentation
        run: |
          mkdir -p docs
          
          cat > docs/backlog.md << 'EOF'
          # Dashboard Tile Backlog
          
          Last updated: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)
          
          ## Recent Tile Updates
          
          EOF
          
          if [ -d "dash/tiles" ]; then
            echo "### Tile Status" >> docs/backlog.md
            echo "" >> docs/backlog.md
            
            for bundle in dash/tiles/*.json; do
              if [ -f "$bundle" ]; then
                tile_id=$(basename "$bundle" .json)
                echo "- âœ“ $tile_id" >> docs/backlog.md
              fi
            done
          fi
          
          cat >> docs/backlog.md << 'EOF'
          
          ## Workflow Status
          
          - Tile Worker: Fetching sources every 15 minutes
          - Tile Loader: Processing and bundling tile data
          - Tile Updater: Updating dashboard and documentation
          
          ## Next Actions
          
          - Monitor tile fetch success rates
          - Review and optimize caching strategies
          - Update profile configurations as needed
          EOF
          
      - name: Create tile summary
        run: |
          if [ -d "dash/tiles" ]; then
            echo "## Dashboard Tile Summary" > tile_summary.md
            echo "" >> tile_summary.md
            echo "Total tiles: $(ls -1 dash/tiles/*.json 2>/dev/null | wc -l)" >> tile_summary.md
            echo "" >> tile_summary.md
            echo "Last update: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" >> tile_summary.md
          fi
          
      - name: Commit updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if tile-data branch exists, create if not
          if git ls-remote --heads origin tile-data | grep tile-data; then
            echo "tile-data branch exists, checking it out..."
            git fetch origin tile-data
            git checkout tile-data
          else
            echo "tile-data branch does not exist, creating it..."
            git checkout -b tile-data
          fi
          
          git add docs/backlog.md tile_summary.md || true
          
          if git diff --staged --quiet; then
            echo "No documentation changes to commit"
          else
            git commit -m "Update dashboard documentation [automated]"
            git push origin tile-data
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Create summary comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let summary = '## ðŸ“Š Dashboard Tile Update\n\n';
            
            if (fs.existsSync('tile_summary.md')) {
              summary += fs.readFileSync('tile_summary.md', 'utf8');
            }
            
            summary += '\n\nâœ… Tiles updated successfully!';
            
            console.log(summary);
            
            // Post to discussions if available
            // This requires additional setup with GitHub Discussions API
            
      - name: Slack notification
        if: ${{ vars.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST ${{ vars.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "ðŸ”„ PR-SJU Dashboard tiles updated successfully!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*PR-SJU Dashboard Update*\n\nDashboard tiles have been refreshed with latest data."
                  }
                }
              ]
            }' || echo "Slack notification skipped (webhook not configured)"
            
      - name: Notion update
        if: ${{ vars.NOTION_API_KEY && vars.NOTION_PAGE_ID }}
        run: |
          echo "Notion integration would update page ${{ vars.NOTION_PAGE_ID }}"
          echo "This requires additional Notion API setup"
          # Placeholder for Notion Manager integration
